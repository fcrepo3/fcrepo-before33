<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
                      
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
  <head>
    <title>Journalling Guide</title>
    <link rel="stylesheet" type="text/css" href="../../docstyle.css" />
  </head>

  <body>

    <div id="header">
      <a href="../../../index.html">
      </a>
      <h1>Journalling Guide</h1>
      <h2>Fedora Release 3.0 Beta 1</h2>
    </div>

    <div id="toc">
      <h2>Table of Contents</h2>
      <ol>
        <li><a href="#intro">Introduction</a></li>
          <ol class="alpha">
            <li><a href="#intro.goals">Goals</a></li>
            <li><a href="#intro.equiv">Repository equivalence</a></li>
            <li><a href="#intro.forensic">Forensic information</a></li>
            <li><a href="#intro.status">Status</a></li>
          </ol>
        <li><a href="#design">Design</a></li>
          <ol class="alpha">
            <li><a href="#design.decorator">A decorator on the Management module</a></li>
            <li><a href="#design.modes">Modes of operation</a></li>
            <li><a href="#design.context">Extended Context interface</a></li>
            <li><a href="#design.hash">The repository hash</a></li>
            <li><a href="#design.repeat">Repeatability</a></li>
            <li><a href="#design.extend">Extensibility</a></li>
          </ol>
        <li><a href="#options">Options</a></li>
          <ol class="alpha">
            <li><a href="#options.general">General options</a></li>
            <li><a href="#options.single">Options for single-file operation</a></li>
            <li><a href="#options.multi">Options for multi-file operation</a></li>
            <li><a href="#options.multicast">Multicast Journaling</a></li>
            <li><a href="#options.log">Options for recovery log</a></li>
          </ol>
        <li><a href="#impl">Implementation</a></li>
          <ol class="alpha">
            <li><a href="#impl.fcfg">Configurations in fedora.fcfg</a></li>
            <li><a href="#impl.journal">Journal content example</a></li>
            <li><a href="#impl.log">Recovery log examples</a></li>
            <li><a href="#impl.sequence">Sequence diagrams</a></li>
          </ol>
        </li>
      </ol>
    </div>
    
    <ol id="content">

      <li>
	    <h2 id="intro">Introduction</h2>
	      <span class="plaintext">
	        The Fedora configuration now includes an optional Journalling module. This module creates Journal files which capture all calls against the Fedora Management API, or rather, all calls that have changed the state of the repository. The Journal files can be replayed against another Fedora instance with the same initial state, resulting in a repository which is a mirror of the original.
	      </span>
	      <ol class="alpha">
            <li>
              <h3 id="intro.goals">Goals</h3>
		        <span class="plaintext">
		          The Journalling module can increase Fedora availability in one of two ways: server recovery to the level of the most recent action, or the creation of a standby server for fast failover.
		          <br />
		          <br />
     		      Without Journalling, a Fedora environment which fails for any reason can only be recovered to the most recent backup. Actions which have occurred since the backup are lost. With Journalling, the environment can be reconstructed to the point of the failure. All successful actions will be recovered, and the server can then resume normal operation.
    		      <br />
    		      <br />
    		      It is also possible to have two Fedora servers operating in a &quot;leader/follower&quot; configuration. The leading server handles requests from users, and creates Journal files to reflect those requests. The following server processes each Journal file as it is completed. If the leading server should fail, the following server will very quickly be ready to take over the handling of user requests.
    		    </span>
		    </li>
            <li>
    	      <h3 id="intro.equiv">Repository equivalence</h3>
    	        <span class="plaintext">
    	          When recovering from a failure, the recovered repository must match the original in all significant ways. PIDs must match those that were initially generated. Timestamps in &quot;create date&quot; or &quot;last modified&quot; fields must reflect the date of the original API call, not the date of the recovery. Generation of PIDs must resume with the same sequence as the original server would have used.
    	          <br />
      	          <br />
      	          The need for deterministic Journalling places limits on Fedora's ability to conduct simultaneous multi-threaded operations. When the Journal module is installed, it synchronizes the calls to the Management module in order to insure that those calls can be replayed in the correct sequence.
    	        </span>
            </li>
            <li>
              <h3 id="intro.forensic">Forensic information</h3>
                <span class="plaintext">
                  The Journal files contain the information that is needed to reconstruct the repository, and some extra information as well. These additional fields are included to permit analysis of the Journal files. Tools that scan the Journal files can easily determine the user and IP address that initiated each API call, as well as the time of the call. Other information may be added to the Journal files to assist in analyzing the server operation.
                </span>
            </li>
            <li>
		      <h3 id="intro.status">Status</h3>
		        <span class="plaintext">
		          The Journalling module currently writes Journal files to a disk directory, and recovers from that same directory. If a &quot;leader/follower&quot; configuration exists with Fedora instances on different servers, those servers must somehow share the directory where the Journal files are written.
		          <br />
		          <br />
	    	      The Journalling module is designed to permit additional transport mechanisms for Journal data, and current plans call for a transport that uses JMS (Java Message Service) instead of file-based transport. No date has been set for this enhancement.
                </span>
            </li>
	      </ol>
	  </li> 
	  <li>
	    <h2 id="design">Design</h2>
	      <ol class="alpha">
            <li>
              <h3 id="design.decorator">A decorator on the Management module</h3>
                <span class="plaintext">
                  The Journalling module uses the Decorator design pattern. The Journaller module implements the Management interface, and adds functionality to each of the methods of that interface before delegating the calls to another Management instance.
                  <br />
                  <br />
                  The design pattern is slightly modified, since the convention in Fedora is that each module will implement its own interface. A new interface was created, called ManagementDelegate, and the Journaller requires a module that implements that interface to use as its delegate.
                  <br />
                  <br />
                  Here is a class diagram for the Management interface, and its implementing class, followed by an excerpt from fedora.fcfg, showing how the module is configured (without Journalling).
                  <br />
                  <br />
                  <em>Class diagram for Management module:</em>
                  <br />
                  <img src="images/ClassDiagramManagement.png" width="319" height="281" alt="Class diagram for Management module" />
                  <br />
                  <br />
                  <em>Configuring the Management module within fedora.fcfg:</em>
                  <br />
                  <code class="block">
<pre>&lt;module role=&quot;fedora.server.management.Management&quot;
     class=&quot;fedora.server.management.DefaultManagement&quot;&gt;
&lt;/module&gt;
</pre>
                  </code>
                  <br />
                  <br />
                  The next class diagram shows the addition of the Journaller module, followed by another excerpt from fedora.fcfg with both Journaller and Management modules. Notice how the Journaller class implements the Management module interface, while the DefaultManagement class has moved to implement ManagementDelegate.
                  <br />
                  <br />
                  <em>Class diagram for the Journaller and Management modules:</em>
                  <br />
		          <img src="images/ClassDiagramJournalManagement.png" width="517" height="374" alt="Class diagram for the Journaller and Management modules" />
		          <br />
		          <br />
		          <em>Configuring the Journaller and Management modules within fedora.fcfg:</em>
		          <br />
                  <code class="block">
<pre>&lt;module role=&quot;fedora.server.management.Management&quot;
     class=&quot;fedora.server.journal.Journaller&quot;&gt;
&lt;/module&gt;
&lt;module role=&quot;fedora.server.management.ManagementDelegate&quot;
     class=&quot;fedora.server.management.DefaultManagement&quot;&gt;
&lt;/module&gt;
</pre>
                  </code>
                </span>
            </li>
            <li>
              <h3 id="design.modes">Modes of operation</h3>
                <span class="plaintext">
                  The Journal operates in one of two modes: &quot;normal&quot;, or &quot;recover&quot;.
                  <br />
                  <br />
                  In normal mode, each call to the Management API is intercepted and passed to the ManagementDelegate. The arguments and the return value from that call are recorded in the Journal.
                  <br />
                  <br />
                  In recover mode, a worker thread processes the Journal files and makes appropriate calls to the ManagementDelegate. Any call from a user is blocked, returning an Exception message.
                  <br />
                  <br />
                  One might expect a third mode of operation, to be used when following another server. In fact, this is implemented using recover mode with a different JournalReader implementation class. This is illustrated in the section &quot;<a href="#impl.fcfg">Configurations in fedora.fcfg</a>&quot;
                </span>
            </li>
            <li>
              <h3 id="design.context">Extended Context interface</h3>
                <span class="plaintext">
                  The behavior of the Management module changes slightly when it is acting as a delegate for the Journaller module. This is accomplished by adding a &quot;recovery&quot; namespace to the Context object that is passed to the methods of the Management module.
                  <br />
                  <br />
                  In normal mode, the Journaller stores information in the recovery namespace of the Context. This information is needed in addition to the arguments and return value of the API method called, in order to fully capture the state of the repository for recovery.
                  <br />
                  <br />
                  When recovering, the Management module will look for this additional information, and use it when executing the API method.
                  <br />
                  <br />
                  For example, if the Ingest method is called and the ingested FOXML does not supply a PID for the object, Fedora will generate one. However, to insure that the same PID is assigned during recovery, the Journaller records the PID, and on recovery the Management module will assign the recorded PID to the new object, instead of generating a new PID which might be different.
                </span>
            </li>
            <li>
              <h3 id="design.hash">The repository hash</h3>
                <span class="plaintext">
                  Each Journal file is tagged with a &quot;repository hash&quot; value, which indicates the internal state of the repository when the Journal file was created. In recover mode, the hash value in the file is compared to the hash value of the new repository. If the values do not match, the recovery is aborted.
                  <br />
                  <br />
                  The repository hash value insures that Journal files are not applied in the wrong order, and that no files are skipped during the recovery. Either of these problems will be detected by comparing the hash values.
                </span>
            </li>
            <li>
              <h3 id="design.repeat">Repeatability</h3>
                <span class="plaintext">
                  A basic concept of Journalling is the repeatability of actions. If a series of actions is executed on two Fedora servers, the result must be two equivalent Fedora repositories.
                  <br />
                  <br />
                  The need for repeatability limits Fedora's ability to use multi-threading in API calls. Multi-threaded operation is non-deterministic by nature, but a Journal file must record a series of events must occur in a particular order, and that order must reflect the actual execution of the events. Otherwise, it would be possible to execute two actions successfully, and to have those same two actions fail on another server, because they were executed in a different order.
                  <br />
                  <br />
                  By careful implementation, this single-threaded sequencing can be reduced to the smallest possible interval, but it cannot be eliminated without breaking the repeatability of the Journal.
                </span>
            </li>
            <li>
              <h3 id="design.extend">Extensibility</h3>
                <span class="plaintext">
                  Some components of the Journaller module are dynamically loaded at server startup time, based on parameter values. The storage and transport mechanisms for the Journals are controlled by these components. It is fairly simple to implement an alternative file structure for the Journal files, or to use a message-based transport instead of simple flat files.
                  <br />
                  <br />
                  The recovery log that is generated by the Journaller is controlled by a similar set of parameters, and can be extended or replaced in the same manner.
                </span>
            </li>
        </ol>
      </li>
      <li>
	    <h2 id="options">Options</h2>
	      <span class="plaintext">
	        These options are recognized by the Journaller module, or by its configurable components. See the section &quot;<a href="#impl.fcfg">Configurations in fedora.fcfg</a>&quot; for examples of how the options are used in fedora.fcfg
	      </span>
          <ol class="alpha">
            <li>
              <h3 id="options.general">General options</h3>
                <span class="plaintext">
                  These options are recognized by the Journaller module, and can be used with any configurable components.
                </span>
                   <ul>
                     <li>journalMode
                     <br />
                     Sets the operating mode of the Journaller module. Optional. Default is &quot;normal&quot;.
                       <ul>
                         <li>normal
                         <br />
                         API calls are performed normally, and a Journal is written.
                         </li>
                         <li>recover
                         <br />
                         The Journal is read and executed, while API calls from outside are rejected.
                         </li>
                       </ul>
                     </li>
                     <li>continueOnHashError
                     <br />
                     Permits the recovery to continue, even if the repository hash does not match the value recorded in the Journal file. Optional. Applies only to recover mode. The default is &quot;false&quot;.
                       <ul>
                         <li>true
                         <br />
                         Errors in the repository hash value will be recorded in the recovery log, but will not cause the recovery to terminate.
                         </li>
                         <li>false
                         <br />
                         Any error in the repository hash value will cause the recovery to terminate immediately.
                         </li>
                       </ul>
                     </li>
                     <li>journalWriterClassname
                     <br />
                     Specifies the configurable component that writes the Journal during normal mode operation. This class must be an extension of fedora.server.journal.JournalWriter. Required for normal mode. There is no default. Note that this component may require additional parameters.
                       <ul>
                         <li>fedora.server.journal.readerwriter.multifile.MultiFileJournalWriter
                         <br />
                         Writes a collection of Journal files to a specified directory on disk. Best class for most operating scenarios.
                         </li>
                         <li>fedora.server.journal.readerwriter.singlefile.SingleFileJournalWriter
                         <br />
                         Writes a single Journal file. This writer is likely to be useful only for testing, since the Journal file will quickly become too large to handle during normal operation.
                         </li>
                       </ul>
                     </li>
                     <li>journalReaderClassname
                     <br />
                     Specifies the configurable component that reads the Journal during recover mode operation. This class must be an extension of fedora.server.journal.JournalReader. Required for recover mode. There is no default. Note that this component may require additional parameters.
                       <ul>
                         <li>fedora.server.journal.readerwriter.multifile.MultiFileJournalReader
                         <br />
                         Reads a collection of Journal files from a specified directory on disk. As each file is processed, it is moved to an &quot;archive&quot; directory. When all files have been processed, recovery is complete. Good class for a recovery scenario.
                         </li>
                         <li>fedora.server.journal.readerwriter.multifile.LockingFollowingJournalReader
                         <br />
                         Monitors a specified directory on disk for the existence of new Journal files. As each file is found, it is processed and moved to the &quot;archive&quot; directory. When all files have been processed, the server will continue to poll the directory for new files. This reader enables a server to &quot;follow&quot; another. It also accepts &quot;lock requests&quot; to pause processing and allow an orderly shutdown (see &quot;lockRequestedFilename&quot; and &quot;lockAcceptedFilename&quot; options below). Best class for a following scenario.
                         </li>
                         <li>fedora.server.journal.readerwriter.multifile.MultiFileFollowingJournalReader
                         <br />
                         Same as LockingFollowingJournalReader, but does not recognize the &quot;lockRequestedFilename&quot; and &quot;lockAcceptedFilename&quot; options.
                         </li>
                         <li>fedora.server.journal.readerwriter.singlefile.SingleFileJournalReader
                         <br />
                         Reads a single Journal file. When the file has been processed, recovery is complete. This reader is likely to be useful only for testing, since the Journal file will quickly become too large to handle during normal operation.
                         </li>
                       </ul>
                     </li>
                     <li>journalRecoveryLogClassname
                     <br />
                     Specifies the configurable component that writes the recovery log during recover mode operation. This class must be an extension of fedora.server.journal.recoverylog.JournalRecoveryLog. Required for recover mode. There is no default. Note that this component may require additional parameters.
                       <ul>
                         <li>fedora.server.journal.recoverylog.RenamingJournalRecoveryLog
                         <br />
                         Writes log messages to a disk file as soon as they are initiated. The path specified in the recoveryLogFilename option is used as the basis for the filename. A timestamp will be appended to the filename in order to avoid a problem with later logs overwriting earlier ones. While recovery is in progress, the filename is preceded by an underscore character. When recovery is complete, the underscore character is removed. This class is best for most operating scenarios.
                         </li>
                         <li>fedora.server.journal.recoverylog.UnbufferedJournalRecoveryLog
                         <br />
                         Writes log messages to a disk file as soon as they are initiated. Writes to a file specified in the recoveryLogFilename option.
                         </li>
                         <li>fedora.server.journal.recoverylog.BufferedJournalRecoveryLog
                         <br />
                         Accumulates log messages in a StringBuffer and writes them to disk only when recovery is complete. This component is useful for testing, since it gives a clear external indication of completion. It will almost certainly be too memory-intensive for normal operation.
                         </li>
                       </ul>
                     </li>
                   </ul>
            </li>
            <br />
            <li>
              <h3 id="options.single">Options for single-file operation</h3>
                <span class="plaintext">
                  These options are recognized by the reader and writer components in the fedora.server.journal.readerwriter.singlefile package.
                </span>
                  <ul>
                    <li>journalFilename
                    <br />
                    The full path to the journal file. Required. There is no default.
                    </li>
                  </ul>
            </li>
            <br />
            <li>
              <h3 id="options.multi">Options for multi-file operation</h3>
                <span class="plaintext">
                  These options are recognized by the reader and writer components in the fedora.server.journal.readerwriter.multifile package:
                </span>
                  <ul>
                    <li>journalDirectory
                    <br />
                    The full path to the directory where the journal files are written. Required. There is no default.
                    </li>
                    <li>archiveDirectory
                    <br />
                    The full path to the directory where the journal files are archived after being processed in recover mode. Required for recover mode. There is no default.
                    </li>
                    <li>journalFilenamePrefix
                    <br />
                    The name of each Journal file will consist of this prefix followed by a timestamp to insure uniqueness. Optional. The default is &quot;fedoraJournal&quot;.
                    </li>
                    <li>journalFileSizeLimit
                    <br />
                    When a Journal file exceeds this size, it is closed. Subsequent API calls will be recorded in a new Journal file. The value must be an integer number of bytes, optionally followed by &quot;K&quot;, &quot;M&quot;, or &quot;G&quot; to indicate Kilobytes, Megabytes, or Gigabytes, respectively. Optional. The default is &quot;5M&quot;.
                    </li>
                    <li>journalFileAgeLimit
                    <br />
                    When the age of a Journal file exceeds this value, it is closed. Subsequent API calls will be recorded in a new Journal file. The value must be an integer number of seconds, optionally followed by &quot;M&quot;, &quot;H&quot;, or &quot;D&quot; to indicate Minutes, Hours, or Days, respectively. Optional. The default is &quot;1D&quot;.
                    </li>
                  </ul>
                <span class="plaintext">
                  Options for following readers only:
                </span>
                  <ul>
                    <li>followPollingInterval
                    <br />
                    The length of time to wait between checking for new journal files. If the journal directory is empty, the JournalReader will wait this number of seconds before checking again. The value must be an integer number of seconds, optionally followed by &quot;M&quot;, &quot;H&quot;, or &quot;D&quot; to indicate Minutes, Hours, or Days, respectively. Optional. The default is &quot;3&quot;.
                    </li>
                  </ul>
                <span class="plaintext">
                  Options for LockingFollowingJournalReader only:
                </span>
                  <ul>
                    <li>lockRequestedFilename
                    <br />
                    The full path of a file which indicates a lock request. After each journal file, the following JournalReader will check to see whether the lock request file is present. If so, the JournalReader will create the lock accepted file (see next option), and enter a polling wait state. This processs allows a safe shutdown of a server in following mode.
                    </li>
                    <li>lockAcceptedFilename
                    <br />
                    The full path of a file which indicates that a lock request has been accepted (see previous option). When the JournalReader creates this file, it is in an idle state, and shutting down the server will not have a negative impact on journal processing.
                    </li>
                  </ul>
            </li>
            <br />
            <li><h3 id="options.multicast">Multicast Journaling</h3>
<span class="plaintext">
The MulticastJournalWriter is configured with one or more Transport objects,
each of which writes an identical set of Journal files to its destination. So
far, these Transport classes are available:
</span>
<ul>
  <li> fedora.server.journal.readerwriter.multicast.LocalDirectoryTransport
  <br/>
Writes a set of Journal files to a directory on the local file system. This
functions very much like a MultiFileJournalWriter, adapted for multicasting.</li>
  <li> fedora.server.journal.readerwriter.multicast.RmiTransport
  <br/>
Writes a set of Journal files to an instance of RmiJournalReceiver running on
the same or another server.</li>
</ul>
<span class="plaintext">
The MulticastJournalWriter can write to any combination of these Transports.
</span>
<span class="plaintext">
If a Transport encounters an error while writing a Journal entry, the action
taken depends on whether the Transport has been configured as "crucial" or
not. If the Transport is not crucial, the exception is written to the log,
and operation continues normally. If the Transport is crucuial, the exception
is passed on, and the user sees an error status on their request, The server
is placed into read-only mode, and will accept no further alterations to the
repository until the error is corrected.
At least one Transport must be configured as "crucial".
</span>
<span class="plaintext">
The following excerpt from <code>fedora.fcfg</code> shows a server that 
writes Journal files to a local file system, and to two follower systems via 
RMI.
<code class="block"><pre>
&lt;module role="fedora.server.management.Management" class="fedora.server.journal.Journaller"&gt;
  &lt;param name="journalFileSizeLimit" value="100M"/&gt;
  &lt;param name="journalFileAgeLimit" value="1H"/&gt;
  &lt;param name="journalWriterClassname"
        value="fedora.server.journal.readerwriter.multicast.MulticastJournalWriter"/&gt;

  &lt;param name="transport.local.classname"
        value="fedora.server.journal.readerwriter.multicast.LocalDirectoryTransport"/&gt;
  &lt;param name="transport.local.directoryPath" value="/usr/local/journals/archiveFiles"/&gt;
  &lt;param name="transport.local.crucial" value="true"/&gt;

  &lt;param name="transport.follow1.classname"
     value="fedora.server.journal.readerwriter.multicast.rmi.RmiTransport"/&gt;
  &lt;param name="transport.follow1.crucial" value="false"/&gt;
  &lt;param name="transport.follow1.hostName" value="follow1.nsdl.org"/&gt;
  &lt;param name="transport.follow1.service" value="RmiJournalReceiver"/&gt;

  &lt;param name="transport.follow2.classname"
     value="fedora.server.journal.readerwriter.multicast.rmi.RmiTransport"/&gt;
  &lt;param name="transport.follow2.crucial" value="false"/&gt;
  &lt;param name="transport.follow2.hostName" value="follow2.nsdl.org"/&gt;
  &lt;param name="transport.follow2.service" value="RmiJournalReceiver"/&gt;
&lt;/module&gt;</pre></code>
</span>
</li>
<br/>

            <li>
              <h3 id="options.log">Options for the recovery log</h3>
                <span class="plaintext">
                  These options are recognized by all of the current RecoveryLog components.
                </span>
                  <ul>
                    <li>recoveryLogFilename
                    <br />
                    The full path of the disk file that will contain the recovery log. Required for recover mode. There is no default.
                    </li>
                    <li>recoveryLogLevel
                    <br />
                    Specifies the amount of information that is written to the recovery log. Optional. The default is &quot;high&quot;.
                      <ul>
                        <li>high
                        <br />
                        Verbose logging. Writes all Journal information to the log, including method identifiers, arguments, and context.
                        </li>
                        <li>medium
                        <br />
                        Writes partial information to the log, including method identifiers and arguments, but omitting contexts.
                        </li>
                        <li>low
                        <br />
                        Terse logging. Writes only method identifiers to the log, omitting contexts and arguments.
                        </li>
                      </ul>
                    </li>
                  </ul>
            </li>
          </ol>
      </li>
      <li>
	    <h2 id="impl">Implementation</h2>
	      <span class="plaintext">
	        This section contains some details of the Journaller implementation, including how to configure it, what it produces, and how it operates.
	      </span>
          <ol class="alpha">
            <li>
              <h3 id="impl.fcfg">Configurations in fedora.fcfg</h3>
                <span class="plaintext">
                  These excerpts from fedora.fcfg show three different examples of how to configure the Journaller module.
                <br />
                <br />
                <em>Configuring for normal mode:</em>
                <br />
                <code class="block">
<pre>&lt;module role=&quot;fedora.server.management.Management&quot;
     class=&quot;fedora.server.journal.Journaller&quot;&gt;
  &lt;param name=&quot;journalDirectory&quot; 
     value=&quot;/usr/local/ndr-content/journals/journalFiles&quot;/&gt;
  &lt;param name=&quot;journalWriterClassname&quot; 
     value=&quot;fedora.server.journal.readerwriter.multifile.MultiFileJournalWriter&quot;/&gt;
  &lt;param name=&quot;journalFileSizeLimit&quot; value=&quot;100M&quot; /&gt;
  &lt;param name=&quot;journalFileAgeLimit&quot; value=&quot;1H&quot; /&gt;
&lt;/module&gt;
&lt;module role=&quot;fedora.server.management.ManagementDelegate&quot; 
     class=&quot;fedora.server.management.DefaultManagement&quot;&gt;
&lt;/module&gt;
</pre>
                </code>
                <br />
                <br />
                <em>Configuring for recover mode:</em>
                <br />
                <code class="block">
<pre>&lt;module role=&quot;fedora.server.management.Management&quot; 
     class=&quot;fedora.server.journal.Journaller&quot;&gt;
  &lt;param name=&quot;journalMode&quot; value=&quot;recover&quot;/&gt;
  &lt;param name=&quot;journalDirectory&quot; 
     value=&quot;/usr/local/ndr-content/journals/journalFiles&quot;/&gt;
  &lt;param name=&quot;archiveDirectory&quot; 
     value=&quot;/usr/local/ndr-content/journals/archiveFiles&quot;/&gt;
  &lt;param name=&quot;journalReaderClassname&quot; 
     value=&quot;fedora.server.journal.readerwriter.multifile.MultiFileJournalReader&quot;/&gt;
  &lt;param name=&quot;journalRecoveryLogClassname&quot; 
     value=&quot;fedora.server.journal.recoverylog.RenamingJournalRecoveryLog&quot;/&gt;
  &lt;param name=&quot;recoveryLogFilename&quot; 
     value=&quot;/usr/local/ndr-content/journals/journal.recovery.log&quot;/&gt;
&lt;/module&gt;
&lt;module role=&quot;fedora.server.management.ManagementDelegate&quot; 
     class=&quot;fedora.server.management.DefaultManagement&quot;&gt;
&lt;/module&gt;
</pre>
                </code>
                <br />
                <br />
                <em>Configuring for recover mode in a &quot;following&quot; server:</em>
                <br />
                <code class="block">
<pre>&lt;module role=&quot;fedora.server.management.Management&quot;
     class=&quot;fedora.server.journal.Journaller&quot;&gt;
  &lt;param name=&quot;journalMode&quot; value=&quot;recover&quot; /&gt;
  &lt;param name=&quot;journalDirectory&quot; 
     value=&quot;/usr/local/ndr-content/journals/journalFiles&quot;/&gt;
  &lt;param name=&quot;archiveDirectory&quot; 
     value=&quot;/usr/local/ndr-content/journals/archiveFiles&quot;/&gt;
  &lt;param name=&quot;journalReaderClassname&quot; 
     value=&quot;fedora.server.journal.readerwriter.multifile.LockingFollowingJournalReader&quot;/&gt;
  &lt;param name=&quot;lockRequestedFilename&quot; 
     value=&quot;/usr/local/ndr-content/journals/StopAcceptingJournals.lock&quot;/&gt;
  &lt;param name=&quot;lockAcceptedFilename&quot; 
     value=&quot;/usr/local/ndr-content/journals/AcceptedJournalStop.lock&quot;/&gt;
  &lt;param name=&quot;journalRecoveryLogClassname&quot; 
     value=&quot;fedora.server.journal.recoverylog.RenamingJournalRecoveryLog&quot;/&gt;
  &lt;param name=&quot;recoveryLogFilename&quot; 
     value=&quot;/usr/local/ndr-content/journals/journal.recovery.log&quot;/&gt;
  &lt;param name=&quot;followPollingInterval&quot; value=&quot;10&quot;/&gt;
&lt;/module&gt;
&lt;module role=&quot;fedora.server.management.ManagementDelegate&quot; 
     class=&quot;fedora.server.management.DefaultManagement&quot;&gt;
&lt;/module&gt;
</pre>
                </code>
                </span>
            </li>
            <li>
              <h3 id="impl.journal">Journal content example</h3>
                <span class="plaintext">
                  This shows the possible content of an entry in the Journal file. The Context structure was simplified for this example. In normal operation a Context will probably contain more keys and values.
                <br />
                <br />
                <code class="block">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;FedoraJournal repositoryHash=&quot;3|2,1,0&quot; timestamp=&quot;2006-06-15T09:45:35.683-0400&quot;&gt;
  &lt;JournalEntry method=&quot;purgeObject&quot; timestamp=&quot;2006-06-15T09:45:35.683-0400&quot; 
      clientIpAddress=&quot;127.0.0.1&quot; loginId=&quot;fedoraAdmin&quot;&gt;
    &lt;context&gt;
      &lt;password&gt;fedoraAdmin&lt;/password&gt;
      &lt;noOp&gt;false&lt;/noOp&gt;
      &lt;now&gt;2006-06-15T09:45:35.683-0400&lt;/now&gt;
      &lt;multimap name=&quot;environment&quot;&gt;
        &lt;multimapkey name=&quot;urn:fedora:names:fedora:2.1:environment:httpRequest:authType&quot;&gt;
          &lt;multimapvalue&gt;BASIC&lt;/multimapvalue&gt;
        &lt;/multimapkey&gt;
        &lt;multimapkey name=&quot;urn:fedora:names:fedora:2.1:environment:httpRequest:serverIpAddress&quot;&gt;
          &lt;multimapvalue&gt;127.0.0.1&lt;/multimapvalue&gt;
        &lt;/multimapkey&gt;
        &lt;multimapkey name=&quot;urn:fedora:names:fedora:2.1:environment:httpRequest:serverPort&quot;&gt;
          &lt;multimapvalue&gt;8080&lt;/multimapvalue&gt;
        &lt;/multimapkey&gt;
        &lt;multimapkey name=&quot;urn:fedora:names:fedora:2.1:environment:httpRequest:method&quot;&gt;
          &lt;multimapvalue&gt;POST&lt;/multimapvalue&gt;
        &lt;/multimapkey&gt;
        &lt;multimapkey name=&quot;urn:fedora:names:fedora:2.1:environment:httpRequest:protocol&quot;&gt;
          &lt;multimapvalue&gt;HTTP/1.1&lt;/multimapvalue&gt;
        &lt;/multimapkey&gt;
      &lt;/multimap&gt;
      &lt;multimap name=&quot;subject&quot;&gt;
        &lt;multimapkey name=&quot;fedoraRole&quot;&gt;
          &lt;multimapvalue&gt;administrator&lt;/multimapvalue&gt;
        &lt;/multimapkey&gt;
        &lt;multimapkey name=&quot;urn:fedora:names:fedora:2.1:subject:loginId&quot;&gt;
          &lt;multimapvalue&gt;fedoraAdmin&lt;/multimapvalue&gt;
        &lt;/multimapkey&gt;
      &lt;/multimap&gt;
      &lt;multimap name=&quot;action&quot;&gt;&lt;/multimap&gt;
      &lt;multimap name=&quot;resource&quot;&gt;&lt;/multimap&gt;
      &lt;multimap name=&quot;recovery&quot;&gt;&lt;/multimap&gt;
    &lt;/context&gt;
    &lt;argument name=&quot;pid&quot; type=&quot;string&quot;&gt;demo:99&lt;/argument&gt;
    &lt;argument name=&quot;message&quot; type=&quot;string&quot;&gt;That dog's gonnna die.&lt;/argument&gt;
    &lt;argument name=&quot;force&quot; type=&quot;boolean&quot;&gt;false&lt;/argument&gt;
  &lt;/JournalEntry&gt;
&lt;/FedoraJournal&gt;
</pre>
                </code>
                </span>
            </li>
            <li>
              <h3 id="impl.log">Recovery log examples</h3>
                <span class="plaintext">
                  These examples show excerpts from recovery logs that were created with different &quot;recoveryLogLevel&quot; settings.
                <br />
                <br />
                <em>Excerpt of recovery log, recoveryLogLevel=low:</em>
                <br />
                <code class="block">
<pre>2006-06-15T09:45:36.605-0400: Event: method='getNextPid', 
            file='C:\fedoraJournal20060615.134531.152Z', 
            entry='2006-06-15T09:45:30.167-0400'
2006-06-15T09:45:36.714-0400: Call complete:getNextPid
</pre>
                </code>
                <br />
                <br />
                <em>Excerpt of recovery log, recoveryLogLevel=medium:</em>
                <br />
                <code class="block">
<pre>2006-06-15T09:45:36.605-0400: Event: method='getNextPid', 
            file='C:\fedoraJournal20060615.134531.152Z', 
            entry='2006-06-15T09:45:30.167-0400'
    arguments
        numPids='4'
        namespace='newPIDs'
2006-06-15T09:45:36.714-0400: Call complete:getNextPid
</pre>
                </code>
                <br />
                <br />
                <em>Excerpt of recovery log, recoveryLogLevel=high:</em>
                <br />
                <code class="block">
<pre>2006-06-15T09:45:36.605-0400: Event: method='getNextPid', 
            file='C:\fedoraJournal20060615.134531.152Z', 
            entry='2006-06-15T09:45:30.167-0400'
    context=fedora.server.journal.entry.JournalEntryContext
        environmentAttributes
            urn:fedora:names:fedora:2.1:environment:httpRequest:authType
                BASIC
            urn:fedora:names:fedora:2.1:environment:httpRequest:security
                urn:fedora:names:fedora:2.1:environment:httpRequest:security-insecure
            urn:fedora:names:fedora:2.1:environment:currentDate
                2006-06-15Z
            urn:fedora:names:fedora:2.1:environment:currentTime
                13:45:30.027Z
            urn:fedora:names:fedora:2.1:environment:httpRequest:sessionStatus
                invalid
            urn:fedora:names:fedora:2.1:environment:httpRequest:scheme
                http
            urn:fedora:names:fedora:2.1:environment:httpRequest:clientIpAddress
                127.0.0.1
            urn:fedora:names:fedora:2.1:environment:httpRequest:contentLength
                576
            urn:fedora:names:fedora:2.1:environment:httpRequest:clientFqdn
                localhost
            urn:fedora:names:fedora:2.1:environment:httpRequest:serverIpAddress
                127.0.0.1
            urn:fedora:names:fedora:2.1:environment:httpRequest:serverPort
                8080
            urn:fedora:names:fedora:2.1:environment:currentDateTime
                2006-06-15T13:45:30.027Z
            urn:fedora:names:fedora:2.1:environment:httpRequest:messageProtocol
                urn:fedora:names:fedora:2.1:environment:httpRequest:messageProtocol-soap
            urn:fedora:names:fedora:2.1:environment:httpRequest:method
                POST
            urn:fedora:names:fedora:2.1:environment:httpRequest:contentType
                text/xml; charset=utf-8
            urn:fedora:names:fedora:2.1:environment:httpRequest:serverFqdn
                localhost
            urn:fedora:names:fedora:2.1:environment:httpRequest:protocol
                HTTP/1.1
        subjectAttributes
            fedoraRole
                administrator
            urn:fedora:names:fedora:2.1:subject:loginId
                fedoraAdmin
        actionAttributes
        resourceAttributes
            urn:fedora:names:fedora:2.1:resource:object:nPids
                4
        recoveryAttributes
            info:fedora/fedora-system:def/recovery#pidList
                newPIDs:1
                newPIDs:2
                newPIDs:3
                newPIDs:4
        password='*********'
        noOp=false
        now=false
    arguments
        numPids='4'
        namespace='newPIDs'
2006-06-15T09:45:36.714-0400: Call complete:getNextPid
</pre>
                </code>
                </span>
            </li>
            <li>
              <h3 id="impl.sequence">Sequence diagrams</h3>
                <span class="plaintext">
                  These UML diagrams give an overview of the control sequences used in creating a Journal (normal mode) or consuming a Journal (recover mode).
                  <br />
                  <br />
                  <em>Creating the journal (click on image to enlarge).</em>
                  <br />
                  <a href="images/CreatingtheJournal.png"><img src="images/CreatingtheJournalReduced.png" alt="Sequence diagram for creating the Journal"></a>
                  <br />
                  <br />
                  <em>Consuming the journal (click on image to enlarge).</em>
                  <br />
                  <a href="images/ConsumingtheJournal.png"><img src="images/ConsumingtheJournalReduced.png" alt="Sequence diagram for consuming the Journal"></a>
                </span>
            </li>
          </ol>
      </li>
    </ol>

    <div id="footer">
      <p id="copyright">
        Copyright &copy; 2002-2007 Fedora Project
      </p>
      <script type="text/javascript">
        var cvsDate = "$Date: 2007-08-01 15:42:14 -0400 (Wed, 01 Aug 2007) $";
        var parts = cvsDate.split(" ");
        var modifiedDate = parts[1];
        var p = document.createElement("p");
        p.setAttribute("id", "lastModified");
        var footer = document.getElementById("footer");
        footer.appendChild(p);
        p.innerHTML = "Last Modified "+modifiedDate;
      </script>
    </div>
    
  </body>
</html>